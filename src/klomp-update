#!/usr/bin/perl
use strict;
use warnings;

if(@ARGV == 1 and $ARGV[0] =~ /^(-h|--help)$/){
  die "Usage:\n"
    . "  $0                        update all libs\n"
    . "  $0 LIB [LIB LIB ..]       updated specified libs\n";
}
my $allLibs = 0;
$allLibs = 1 if @ARGV == 0;
my %okLibs = map {$_ => 1} @ARGV;

my @libs = `klomp-lib`;
chomp foreach @libs;

if(not -e "$ENV{HOME}/.klompdb"){
  print "No db file; creating from scratch\n";
  system 'klomp-db', '-c';
}

for my $lib(@libs){
  if(not $allLibs and not defined $okLibs{$lib}){
    print "\nSkipped library: $lib\n";
    next;
  }
  print "\nHandling library: $lib\n";

  system 'klomp-db', '-m', $lib;
  system 'klomp-db', '-u', $lib;
}

for my $lib(@libs){
  if(not $allLibs and not defined $okLibs{$lib}){
    print "\nSkipped flacmirror for: $lib\n";
    next;
  }
  my $dir = `klomp-lib -l $lib`;
  chomp $dir;
  my $flacMirrorDir = `klomp-lib -f $lib`;
  chomp $flacMirrorDir;
  system "mkdir", "-p", $flacMirrorDir if $flacMirrorDir;
  
  if(-e $flacMirrorDir and -e $dir){
    print "\nflacmirror for: $lib\n";
    system "flacmirror $dir $flacMirrorDir";
  }
}
